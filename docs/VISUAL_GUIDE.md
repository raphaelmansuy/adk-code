# Code Agent: Visual Architecture Guide

One-page visual overview of the entire system.

---

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER (Terminal)                            â”‚
â”‚                                                                    â”‚
â”‚  â¯ How do I write a Go server?                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   REPL (readline loop)  â”‚
        â”‚                         â”‚
        â”‚  â€¢ Prompt user          â”‚
        â”‚  â€¢ Handle /commands     â”‚
        â”‚  â€¢ Invoke agent         â”‚
        â”‚  â€¢ Display results      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼ genai.Content
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ADK Agent (Agentic Loop)            â”‚
    â”‚                                      â”‚
    â”‚  1. Send to LLM                      â”‚
    â”‚  2. Parse tool calls                 â”‚
    â”‚  3. Execute tools                    â”‚
    â”‚  4. Stream results                   â”‚
    â”‚  5. Iterate until stop               â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚
           â–¼                 â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    Tools     â”‚   â”‚   LLM Calls  â”‚
   â”‚  (30+)       â”‚   â”‚              â”‚
   â”‚              â”‚   â”‚  Gemini      â”‚
   â”‚ â€¢ ReadFile   â”‚   â”‚  Vertex AI   â”‚
   â”‚ â€¢ WriteFile  â”‚   â”‚  OpenAI      â”‚
   â”‚ â€¢ ReplaceIn  â”‚   â”‚              â”‚
   â”‚ â€¢ Execute    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ â€¢ Search     â”‚
   â”‚ â€¢ Patch      â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Display Rendering   â”‚
  â”‚                      â”‚
  â”‚  â€¢ Thinking output   â”‚
  â”‚  â€¢ Tool execution    â”‚
  â”‚  â€¢ Results           â”‚
  â”‚  â€¢ Colors/markdown   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Architecture (4-Part System)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ORCHESTRATOR (Builder)                     â”‚
â”‚                                                             â”‚
â”‚  Application.New() creates all 4 components:              â”‚
â”‚  .WithDisplay().WithModel().WithAgent().WithSession()    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚          â”‚          â”‚          â”‚
       â–¼          â–¼          â–¼          â–¼
   â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚     â”‚  â”‚        â”‚  â”‚       â”‚  â”‚         â”‚
   â”‚DIS- â”‚  â”‚ MODEL  â”‚  â”‚ AGENT â”‚  â”‚SESSION  â”‚
   â”‚PLAY â”‚  â”‚        â”‚  â”‚       â”‚  â”‚         â”‚
   â”‚     â”‚  â”‚        â”‚  â”‚       â”‚  â”‚         â”‚
   â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚         â”‚          â”‚           â”‚
     â”‚         â”‚          â”‚           â”‚
   Renders   LLM       Thinks &    Persists &
   output  selection  executes    tracks
            (3 back-  tools with   session
             ends)    output       tokens
                      streaming

    internal/     pkg/       ADK       internal/
    display/      models/   Agent     session/
    (8 sub-       (registry)framework
     packages)
```

---

## REPL Loop (Interactive Mode)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ REPL.Run() - Infinite Loop              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  readline()    â”‚
          â”‚  Read user     â”‚
          â”‚  input         â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Is it a command?    â”‚
        â”‚ (/help, /models)    â”‚
        â”‚?                    â”‚
        â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
      YESâ”‚          NO   â”‚
         â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Handle      â”‚  â”‚Create user   â”‚
    â”‚command     â”‚  â”‚message       â”‚
    â”‚            â”‚  â”‚              â”‚
    â”‚ â€¢ /help    â”‚  â”‚genai.Content â”‚
    â”‚ â€¢ /models  â”‚  â”‚{Role: User,  â”‚
    â”‚ â€¢ /use     â”‚  â”‚Text: input}  â”‚
    â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚ Continue   â”‚           â”‚
    â”‚ loop       â”‚           â–¼
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚agent.Run(ctx, msg)
                    â”‚                  â”‚
                    â”‚ Agentic loop:    â”‚
                    â”‚                  â”‚
                    â”‚ 1. Call LLM      â”‚
                    â”‚ 2. Parse tools   â”‚
                    â”‚ 3. Execute       â”‚
                    â”‚ 4. Collect       â”‚
                    â”‚    results       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚EventTimeline     â”‚
                    â”‚                  â”‚
                    â”‚ Thinking         â”‚
                    â”‚ Tool execution   â”‚
                    â”‚ Results          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚Render timeline   â”‚
                    â”‚to terminal       â”‚
                    â”‚                  â”‚
                    â”‚Colors, markdown, â”‚
                    â”‚spinners          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Continue loop    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Next prompt      â”‚
                    â”‚ â¯ _             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Tool Execution Flow

```
Agent receives LLM response with tool calls
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ For each tool call:     â”‚
    â”‚                         â”‚
    â”‚ 1. Look up tool by name â”‚
    â”‚ 2. Validate input JSON  â”‚
    â”‚ 3. Execute handler      â”‚
    â”‚ 4. Get output struct    â”‚
    â”‚ 5. Append to context    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Tool Registry (common)    â”‚
    â”‚                           â”‚
    â”‚ "read_file"      â”€â”€â”€â”€â”    â”‚
    â”‚ "write_file"     â”€â”€â”€â”€â”¤    â”‚
    â”‚ "execute"        â”€â”€â”€â”€â”¤ Lookup by name
    â”‚ "grep_search"    â”€â”€â”€â”€â”¤    â”‚
    â”‚ ... 26 more ...  â”€â”€â”€â”€â”˜    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Tool Definition (e.g. read_file) â”‚
    â”‚                                  â”‚
    â”‚ Input:  ReadFileInput            â”‚
    â”‚   {path, offset, limit}          â”‚
    â”‚                                  â”‚
    â”‚ Handler: readFileHandler()       â”‚
    â”‚   Validates input                â”‚
    â”‚   Reads file                     â”‚
    â”‚   Returns ReadFileOutput         â”‚
    â”‚                                  â”‚
    â”‚ Output: ReadFileOutput           â”‚
    â”‚   {success, content, error}      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Tool execution results          â”‚
    â”‚                                 â”‚
    â”‚ Result appended to conversation â”‚
    â”‚ Agent uses result to call LLM    â”‚
    â”‚ Cycle continues                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Tool Categories Map

```
Tools/ (8 categories, ~30 total)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE OPERATIONS                                              â”‚
â”‚ â€¢ ReadFile      - Read with offset/limit                    â”‚
â”‚ â€¢ WriteFile     - Atomic write                              â”‚
â”‚ â€¢ ReplaceInFile - Safe text replacement                     â”‚
â”‚ â€¢ ListDirectory - Recursive listing                         â”‚
â”‚ â€¢ SearchFiles   - Pattern search                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CODE EDITING                                                 â”‚
â”‚ â€¢ ApplyPatch    - Multi-format patches                      â”‚
â”‚ â€¢ EditLines     - Line-by-line edits                        â”‚
â”‚ â€¢ SearchReplace - Regex/literal search & replace            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SEARCH & DISCOVERY                                           â”‚
â”‚ â€¢ PreviewReplace    - Dry-run preview                       â”‚
â”‚ â€¢ GrepSearch        - Regex matching                        â”‚
â”‚ â€¢ FileAnalysis      - Content analysis                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EXECUTION                                                    â”‚
â”‚ â€¢ ExecuteCommand    - Run shell commands                    â”‚
â”‚ â€¢ ExecuteProgram    - Run programs with args                â”‚
â”‚ â€¢ PipelineExec      - Chain commands                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WORKSPACE                                                    â”‚
â”‚ â€¢ GetFileInfo       - Metadata                              â”‚
â”‚ â€¢ ProjectAnalysis   - Structure analysis                    â”‚
â”‚ â€¢ WorkspaceTools    - VCS-aware operations                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DISPLAY                                                      â”‚
â”‚ â€¢ DisplayMessage    - Agentâ†’UI messaging                    â”‚
â”‚ â€¢ UpdateTaskList    - Task list updates                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ V4A PATCHES (Alternative Format)                             â”‚
â”‚ â€¢ ApplyV4APatch     - Unified patch format                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BASE / REGISTRY                                              â”‚
â”‚ â€¢ ToolRegistry      - Tool discovery                        â”‚
â”‚ â€¢ ErrorCodes        - Standard errors                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Model Selection Flow

```
User runs: code-agent --model gpt-4o --backend gemini

                      â”‚
                      â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ config.LoadFromEnv()  â”‚
          â”‚                       â”‚
          â”‚ Parse CLI flags       â”‚
          â”‚ Check env vars        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ orchestration.Initialize   â”‚
          â”‚ ModelComponents()          â”‚
          â”‚                            â”‚
          â”‚ registry.ResolveModel()    â”‚
          â”‚ (model ID, backend)        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Model Registry Lookup       â”‚
        â”‚                             â”‚
        â”‚ Priority:                   â”‚
        â”‚ 1. Explicit model ID        â”‚
        â”‚ 2. Backend default          â”‚
        â”‚ 3. Global default           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Returns Config:               â”‚
        â”‚ â€¢ ID: "gpt-4o"               â”‚
        â”‚ â€¢ Backend: "openai"          â”‚
        â”‚ â€¢ ContextWindow: 128,000     â”‚
        â”‚ â€¢ Capabilities: vision, toolsâ”‚
        â”‚ â€¢ CostTier: "premium"        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Create LLM Adapter         â”‚
        â”‚                            â”‚
        â”‚ For OpenAI:                â”‚
        â”‚ NewOpenAIAdapter(          â”‚
        â”‚   model="gpt-4o",          â”‚
        â”‚   apiKey=OPENAI_API_KEY    â”‚
        â”‚ )                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Ready to use              â”‚
        â”‚                           â”‚
        â”‚ Agent calls llm.Generate()â”‚
        â”‚ which routes to OpenAI    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Session Persistence

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SessionManager               â”‚
â”‚                              â”‚
â”‚ Manages:                     â”‚
â”‚ â€¢ CreateSession()            â”‚
â”‚ â€¢ GetSession()               â”‚
â”‚ â€¢ ListSessions()             â”‚
â”‚ â€¢ DeleteSession()            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SQLite Database     â”‚
    â”‚                     â”‚
    â”‚ ~/.code_agent/      â”‚
    â”‚  sessions.db        â”‚
    â”‚                     â”‚
    â”‚ Tables:             â”‚
    â”‚ â€¢ sessions          â”‚
    â”‚   - user_id         â”‚
    â”‚   - session_id      â”‚
    â”‚   - state (JSON)    â”‚
    â”‚   - created_at      â”‚
    â”‚                     â”‚
    â”‚ â€¢ messages          â”‚
    â”‚   - role (user/asst)â”‚
    â”‚   - content         â”‚
    â”‚   - tokens used     â”‚
    â”‚   - created_at      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Token Tracking:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SessionTokens (in-memory)    â”‚
â”‚                              â”‚
â”‚ Tracks per request:          â”‚
â”‚ â€¢ Input tokens               â”‚
â”‚ â€¢ Output tokens              â”‚
â”‚ â€¢ Total for session          â”‚
â”‚ â€¢ Cost estimation            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Display System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Display Subsystem (internal/display/)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                   â”‚
    â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Renderer         â”‚       â”‚ StreamingDisplay     â”‚
â”‚                  â”‚       â”‚                      â”‚
â”‚ ANSI colors      â”‚       â”‚ Real-time output     â”‚
â”‚ Styling          â”‚       â”‚ during agent        â”‚
â”‚ Formatting       â”‚       â”‚ execution           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                      â”‚
    â–¼                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Output Formatters  â”‚         â”‚ EventTimeline        â”‚
â”‚                    â”‚         â”‚                      â”‚
â”‚ â€¢ Markdown render  â”‚         â”‚ Collects:            â”‚
â”‚ â€¢ JSON format      â”‚         â”‚ â€¢ Thinking events    â”‚
â”‚ â€¢ Plain text       â”‚         â”‚ â€¢ Tool execution     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ â€¢ Results            â”‚
                               â”‚ â€¢ Errors             â”‚
                               â”‚ â€¢ Progress           â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                          â”‚
                          â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Terminal     â”‚
                    â”‚ Output       â”‚
                    â”‚              â”‚
                    â”‚ â¯ How do I...â”‚
                    â”‚              â”‚
                    â”‚ ğŸ¤” Thinking..â”‚
                    â”‚              â”‚
                    â”‚ ğŸ“‚ Reading.. â”‚
                    â”‚              â”‚
                    â”‚ âœ… Here's...  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow: A Complete Request

```
User Input
   â”‚
   â–¼
REPL.readline()
   â”‚
   â”œâ”€ Check if /command â†’ Handle built-in
   â”‚
   â””â”€ Create genai.Content{Role: User, Text: input}
      â”‚
      â–¼
   agent.Run(ctx, content)
      â”‚
      â”œâ”€ Call LLM with context
      â”‚  â”œâ”€ System prompt
      â”‚  â”œâ”€ Conversation history
      â”‚  â””â”€ Available tools (JSON schema)
      â”‚
      â”œâ”€ Receive response
      â”‚  â”œâ”€ Thinking (if enabled)
      â”‚  â””â”€ Tool calls
      â”‚
      â”œâ”€ For each tool call:
      â”‚  â”œâ”€ Validate input
      â”‚  â”œâ”€ Execute tool
      â”‚  â””â”€ Collect result
      â”‚
      â”œâ”€ Append results to context
      â”‚
      â””â”€ Repeat until stop_reason = END_TURN
         â”‚
         â–¼
      Collect EventTimeline
      â”œâ”€ Thinking events
      â”œâ”€ Tool execution events
      â”œâ”€ Result events
      â””â”€ Error events
         â”‚
         â–¼
      Display.Render(timeline)
      â”œâ”€ Colors & formatting
      â”œâ”€ Markdown rendering
      â”œâ”€ Spinner feedback
      â””â”€ Stream to terminal
         â”‚
         â–¼
      SessionTokens.Track()
      â”œâ”€ Count input tokens
      â”œâ”€ Count output tokens
      â””â”€ Save to session
         â”‚
         â–¼
      Continue REPL loop
      â¯ _
```

---

## Key File Relationships

```
main.go
  â”‚
  â”œâ”€> app.New()
  â”‚    â”‚
  â”‚    â”œâ”€> orchestration.NewOrchestrator()
  â”‚    â”‚    â”œâ”€> WithDisplay()
  â”‚    â”‚    â”‚   â””â”€> internal/display/*
  â”‚    â”‚    â”œâ”€> WithModel()
  â”‚    â”‚    â”‚   â””â”€> pkg/models/
  â”‚    â”‚    â”œâ”€> WithAgent()
  â”‚    â”‚    â”‚   â””â”€> ADK agent + tools/
  â”‚    â”‚    â””â”€> WithSession()
  â”‚    â”‚        â””â”€> internal/session/
  â”‚    â”‚
  â”‚    â””â”€> repl.New()
  â”‚        â””â”€> internal/repl/repl.go
  â”‚
  â””â”€> app.Run()
       â””â”€> repl.Run()
            â”œâ”€> readline loop
            â”œâ”€> cli.HandleBuiltinCommand()
            â”œâ”€> agent.Run()
            â””â”€> display.Render()
```

---

## Configuration Precedence

```
User runs: code-agent --model gpt-4o --api-key sk-...

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ CLI Flags (Highest)        â”‚
        â”‚ --model gpt-4o             â”‚
        â”‚ --api-key sk-...           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Environment Variables        â”‚
        â”‚ OPENAI_API_KEY               â”‚
        â”‚ GOOGLE_API_KEY               â”‚
        â”‚ GOOGLE_CLOUD_PROJECT         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Defaults (Lowest)            â”‚
        â”‚ model: gemini-2.5-flash      â”‚
        â”‚ db: ~/.code_agent/sessions.dbâ”‚
        â”‚ format: rich                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Final Config used to initialize all components.
```

---

## Learning Path Flowchart

```
START: New to Code Agent?
   â”‚
   â”œâ”€ Yes â†’ Read QUICK_REFERENCE.md (2 min)
   â”‚        â””â”€ Build & run app
   â”‚           â””â”€ Try in REPL
   â”‚
   â”œâ”€ Want to understand design?
   â”‚  â””â”€ Read ARCHITECTURE.md (15 min)
   â”‚     â””â”€ Study this diagram
   â”‚        â””â”€ Explore code
   â”‚
   â”œâ”€ Want to create a tool?
   â”‚  â””â”€ Read TOOL_DEVELOPMENT.md (20 min)
   â”‚     â””â”€ Study pattern
   â”‚        â””â”€ Implement tool
   â”‚           â””â”€ Test it
   â”‚
   â””â”€ Want deep understanding?
      â””â”€ Read draft.md (reference)
         â””â”€ Study all files
            â””â”€ Contribute to core
```

---

## Summary Table

| Aspect | Key Point |
|--------|-----------|
| **Core Principle** | Component composition, clean separation of concerns |
| **Architecture** | 4 independent components (Display, Model, Agent, Session) |
| **Tools** | 30+ tools across 8 categories, auto-registered |
| **LLM Support** | 3 backends (Gemini, Vertex AI, OpenAI) swappable at runtime |
| **UI** | Rich terminal rendering, markdown, spinners, streaming |
| **Persistence** | SQLite sessions, conversation history, token tracking |
| **Code Size** | ~1000 lines critical code (highly scalable) |
| **Testing** | Comprehensive tests, Makefile targets |
| **Pattern** | Builder (Orchestrator), Tool Factory, Adapter, Composition |

